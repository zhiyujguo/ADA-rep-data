---
title: "ADA_estimation"
author: "Jessica Guo"
date: "2023-07-24"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(1000)
library(topicmodels)
library(dplyr)
library(NLP)
library(papeR)
library(tidytext)
library(ggplot2)
library(tm)
library(tidyr)
library(wordcloud)
library(rJava)
library(randChecks)
library(stm)
library(quanteda)
library(corpus)
library(quanteda.sentiment)
library(quanteda.dictionaries)
library(quanteda.corpora)
library(quanteda.textstats)
library(textreg)
library(MatchIt)
library(data.table)
library(cobalt)
library(designmatch)
library(cem)
library(lsa)
library(SuperLearner)
library(npcausal)
library(lmtest)
library(sandwich)
```


```{r, doubly robust}
ate_full_ups <-ate(log(cov_15$ups+2),cov_15$gender,cov_15[,!names(cov_15) %in% c("gender","num_comments")],
                      nsplits = 2, sl.lib = c("SL.glm","SL.ranger","SL.glmnet","SL.gam"))

ate_full_comm <-ate(log(cov_15$num_comments+2),cov_15$gender,cov_15[,!names(cov_15) %in% c("gender","ups")],
                      nsplits = 2, sl.lib = c("SL.glm","SL.ranger","SL.glmnet","SL.gam"))

cov_names <- names(subset(cov_15,select = -c(gender,ups,num_comments)))
ate_m_ups <- ate(log(matched.cardlasso$ups+2), matched.cardlasso$gender,
                 matched.cardlasso[,names(matched.cardlasso) %in% cov_names],
                 nsplits = 2, sl.lib = c("SL.glm","SL.ranger","SL.glmnet","SL.gam"))
ate_m_comm <- ate(log(matched.cardlasso$num_comments+2), matched.cardlasso$gender,
                  matched.cardlasso[,names(matched.cardlasso) %in% cov_names],
                 nsplits = 2, sl.lib = c("SL.glm","SL.ranger","SL.glmnet","SL.gam"))
```


```{r, mean diff}
full_comm_tau <- mean(log(cov_15$num_comments[cov_15$gender == "1"]+2))-
  mean(log(cov_15$num_comments[cov_15$gender == "0"]+2))
se_full_comm <- sqrt(var(log(cov_15$num_comments[cov_15$gender == "1"]+2))/nrow(cov_15[cov_15$gender == "1",])+var(log(cov_15$num_comments[cov_15$gender == "0"]+2))/nrow(cov_15[cov_15$gender == "0",]))


full_ups_tau <- mean(log(cov_15$ups[cov_15$gender == "1"]+2))-
  mean(log(cov_15$ups[cov_15$gender == "0"]+2))
se_full_ups <- sqrt(var(log(cov_15$ups[cov_15$gender == "1"]+2))/nrow(cov_15[cov_15$gender == "1",])+var(log(cov_15$ups[cov_15$gender == "0"]+2))/nrow(cov_15[cov_15$gender == "0",]))

m_comm_tau <- mean(log(matched.cardlasso$num_comments[matched.cardlasso$gender == "1"]+2))-
  mean(log(matched.cardlasso$num_comments[matched.cardlasso$gender == "0"]+2))
se_m_comm <- sqrt(var(log(matched.cardlasso$num_comments[matched.cardlasso$gender == "1"]+2))/nrow(matched.cardlasso[matched.cardlasso$gender == "1",])+var(log(matched.cardlasso$num_comments[matched.cardlasso$gender == "0"]+2))/nrow(matched.cardlasso[matched.cardlasso$gender == "0",]))

m_ups_tau <- mean(log(matched.cardlasso$ups[matched.cardlasso$gender == "1"]+2))-
  mean(log(matched.cardlasso$ups[matched.cardlasso$gender == "0"]+2))
se_m_ups <- sqrt(var(log(matched.cardlasso$ups[matched.cardlasso$gender == "1"]+2))/nrow(matched.cardlasso[matched.cardlasso$gender == "1",])+var(log(matched.cardlasso$ups[matched.cardlasso$gender == "0"]+2))/nrow(matched.cardlasso[matched.cardlasso$gender == "0",]))
```



```{r, linear reg plug in}
# full
cov_15 = cov_15%>%  mutate_at(c("gender","Jan_indic","Feb_indic","Mar_indic","Apr_indic",
                                "May_indic","Jun_indic","Jul_indic","Aug_indic",
                                "Sep_indic","Oct_indic","Nov_indic","Dec_indic"), as.numeric)
x2 <- matrix(nrow = nrow(cov_15), ncol = 71)
for (i in 1:71){
  x2[,i] = scale(cov_15[,-c(46,73,74)][,i],scale = F)
}
x3 <- cov_15$gender*x2
colnames(x3) <- paste(colnames(cov_15[,-c(46,73,74)]), "gender", sep=":")
data_full = cbind(cov_15,x3)
lm_lasso_ups <- lm(log(ups+2)~.-num_comments, data = data_full)
coefci(lm_lasso_ups, vcov = vcovHC(lm_lasso_ups, type = "HC2"))

lm_lasso_comm <- lm(log(num_comments+2)~.-ups, data = data_full)
coefci(lm_lasso_comm, vcov = vcovHC(lm_lasso_comm, type = "HC2"))

# matched
matched.cardlasso = matched.cardlasso %>%  mutate_at(c("gender","Jan_indic","Feb_indic",
                                                       "Mar_indic","Apr_indic",
                                "May_indic","Jun_indic","Jul_indic","Aug_indic",
                                "Sep_indic","Oct_indic","Nov_indic","Dec_indic"), as.numeric)
x2 <- matrix(nrow = nrow(matched.cardlasso), ncol = 71)
for (i in 1:71){
  x2[,i] = scale(matched.cardlasso[,-c(46,73:77)][,i],scale = F)
}
x3 <- matched.cardlasso$gender*x2
colnames(x3) <- paste(colnames(matched.cardlasso[,-c(46,73:77)]), "gender", sep=":")
data_full = cbind(matched.cardlasso[, !names(matched.cardlasso) %in% c("distance","weights","subclass")] ,x3)
lm_lasso_ups <- lm(log(ups+2)~.-num_comments, data = data_full)
coefci(lm_lasso_ups, vcov = vcovHC(lm_lasso_ups, type = "HC2"))

lm_lasso_comm <- lm(log(num_comments+2)~.-ups, data = data_full)
coefci(lm_lasso_comm, vcov = vcovHC(lm_lasso_comm, type = "HC2"))

```


```{r, plots}
# Propensity Score by gender

# full
findex_full = which(cov_15$gender == "1")
plot(density(ate_full_ups$nuis$pi_a1[findex_full]),col = "red",main = "PS Plot, Full",xlab = "")
lines(density(ate_full_ups$nuis$pi_a1[-c(findex_full)]),col = "blue")
legend('topleft',legend=c("Female", "Male"),
       col=c("red", "blue"), lty=1, cex=0.8)

# matched
findex_m = which(matched.cardlasso$gender == "1")
plot(density(ate_m_ups$nuis$pi_a1[findex_m]),col = "red",main = "PS Plot, Matched")
lines(density(ate_m_ups$nuis$pi_a1[-c(findex_m)]),col = "blue")
legend('topleft',legend=c("Female", "Male"),
       col=c("red", "blue"), lty=1, cex=0.8)
```


```{r}
#Superlearner
# pls see sl_pred.R
# with  SL.library = c("SL.mean", "SL.glmnet", "SL.ranger","SL.knn","SL.bayesglm","SL.xgboost")
df_temp <- readRDS("df_temp.RDS")
findex <- which(df_temp$gender == "1")
plot(density(df_temp$V1[findex]),col = "red",main = "PS Plot, Full",xlab = "", xlim = c(0,1))
lines(density(df_temp$V1[-c(findex)]),col = "blue")
legend('topleft',legend=c("Female", "Male"),
       col=c("red", "blue"), lty=1, cex=0.8)

# with SL.library = c("SL.glm","SL.ranger","SL.glmnet","SL.gam")
df_temp <- readRDS("df_temp.RDS")
plot(density(df_temp$V1[findex]),col = "red",main = "PS Plot, Full",xlab = "",xlim = c(0,0.001))
lines(density(df_temp$V1[-c(findex)]),col = "blue")
legend('top',legend=c("Female", "Male"),
       col=c("red", "blue"), lty=1, cex=0.8)
# IF value differences between full and matched set
hist(ate_full_ups$ifvals[,2]-ate_full_ups$ifvals[,1],col = "red",
     main = "Histogram of estimated IF values differences",
     xlab = "Influence function value differences")
hist(ate_m_ups$ifvals[,2]-ate_m_ups$ifvals[,1], add = T, col = "yellow")
legend(x = "topright",legend = c("DR - full", "DR - card+lasso matched"),
       lty = c(1, 1),
       col = c("red", "yellow"),
       lwd = 2)

```